---
title: "wlsd: Wrangling Longitudinal Survival Data"
author: Charles Ingulli
date: July 8, 2020
output: 
  rmarkdown::html_vignette: default
  hmtl_document: default
  pdf_document: default
vignette: >
  %\VignetteIndexEntry{wlsd}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```



# Introduction

Survival analysis data may come in different usable forms. Transitioning between formats requires detailed knowledge on how information is parsed and how variables are treated. The `wlsd` package in R seeks to provide methods for transforming data between usable formats in an effort to ease this process. `wlsd` can transition between the counting process format and longitudinal or panel format. 


## Data Formats

The relevant data formats that are used in this package are described below. They include longitudinal data (panel data), counting process data, right censored data



### Longitudinal Format

A longitudinal study is a repeated observation method by which to investigate a phenomenon. These studies are often carried out over large quantities of time with the phenomenon being measured at snapshots of the process. Subsequently, longitudinal data is the format adopted by these studies. An equivalent term is a panel study and similarly panel data. Both terminologies refer to the same respective topics. The semantic difference lies in what the repeated observation is. If we are repeatedly observing individuals, the term panel may be more appropriate. For a more general subject, the term longitudianl may be more appropriate (Cite). For our purposes, we use the terms interchangably as they are effectively the same. Longitudinal data refers to data in long form where each row corresponds to a specific time point. This is method is used  For an individual with 10 follow-up observations, data will consist of 10 rows with values at each time. 


```{r, echo = FALSE, results = "asis"}
table1 <- data.frame(id = c(1,1,1,1,2,2,2,3,3),
                     time = c(0,31,64,96,0,33,59,0,28),
                     event = c(0,0,0,1,0,0,1,0,1))
pander::pandoc.table(table1, style = "rmarkdown", caption = "Table 1: Longitudinal Data")
```


### Counting Process Format

One common data setup for survival analysis is the counting process format. This data is set up with two time variables and an event indicator. The variables describe a time interval between the two time points where the event indicator describes 


Let us consider a survival study of 3 individuals. Individuals are followed from the time of enrollment in the study until the event of interest occurs with monthly follow up visits. The initial visit will be referred to as the baseline where all individuals are assumed to be event free. At the monthly follow ups, individuals are tested to assess whether or not they have experienced the event. Time is represented by intervals between visits with an associated event indicator variable. A visual depiction of the data is shown below in Table 1 where time is measured in days. 

```{r, echo = FALSE, results = "asis"}
table2 <- data.frame(id = c(1,1,1,2,2,3),
                              time1 = c(0,31,64,0,33,0),
                              time2 = c(31,64,96,33,59,28),
                              event = c(0,0,1,0,0,1))
pander::pandoc.table(table2, style = "rmarkdown", caption = "Table 2: Counting Process Data")
```

The variable representation of each column is :

* **id** - the individual's identification number.
* **time1** - the left end point of the time interval.
* **time2** - the right end point of the time interval.
* **event** - the event indicator (0 denotes no event and 1 denotes having the event).

Each row of the data corresponds to a particular time interval for each individual. We can see in the first row that individual 1 started the study at time 0 and had a follow up visit 31 days later. At day 31, individual 1 is tested for the event and is determined to have not experienced the event. Time intervals are considered open on the left and closed on the right. That is, for times $t_1$ and $t_2$ where $t_1 < t_2$, the time interval is $(t_1, t_2]$. Looking at the third row, individual 1 starts a new time interval at day 64 and is seen for another follow up at day 96. At time 96, individual 1 is tested and is marked as experiencing the event.


Some data sets may also incorporate one or more explanatory variables. Often in survival studies other variables are measured that possibly relate to the event of interest. These variables may be constant over time or may vary over time. Additionally, they may be qualitative variables or quantitative variables. Consider our previous example of 3 individuals. Let's say that in addition to measuring for the event of interest, individuals were also measured for age at baseline and the amount of medication they receive at that appointment. The former can be considered a constant variable while the latter can be considered a time varying variable. An individual's age at baseline will not change but the amount of medication received by a patient in a survival study may change as the illness progresses. Both constant and time varying variables have a big effect on how the data set is organized as each row is used for a single time interval. 


The coding for new variables is:

* **age** - the numerical age of the individual in years at their baseline visit.
* **meds** - the level of medication received by an individual between visits (0 is for low, 1 is for medium, and 2 is for high).

In this example, age is a constant quantitative variable where as meds is a time varying qualitative variable. We create 3 levels for meds where individuals can be classified as receiving a low, medium, or high amount of medication.
Table 2 shows how these additional explanatory variables would be incorporated in counting process format.

```{r, echo = FALSE, results = "asis"}
table3 <- data.frame(id = c(1,1,1,2,2,3),
                     time1 = c(0,31,64,0,33,0),
                     time2 = c(31,64,96,33,59,28),
                     event = c(0,0,1,0,0,1),
                     age = c(46,46,46,39,39,57),
                     meds = c(0,1,2,0,1,2)
                     )
pander::pandoc.table(table3, style = "rmarkdown", caption = "Table 3: Counting Process Data with Explanatory Variables")

```



The constant variables have the same interpretation at every time point. Individual 1 was measured to be 46 years at baseline and each subsequent visit individual 1 was still 46 years at baseline.


Time varying variables require a bit more interpretation. Even though the variables technically vary over time, they are considered to be constant between intervals (Cite). The intervals are still set up to be open on the left and closed on the right. Looking at individual 1 in Table 2, we can interpret the variables of the first row as the baseline visit. This means that at the baseline time of 0 this individual has a meds level of 0 corresponding to a low amount of medication received. At the first follow-up visit, time 31, the medication level is measured again and assigned a new value, medium. However, because of the way the intervals are set up this value does not yet take effect. The new value clicks in immediately after the follow-up visit. Individual 1's complete meds values are 0 for $(0,31]$, 1 for $(31,64]$, and 2 for $(64,96]$. Even though the value of 1 was measured at time 31, it applies to the following interval.


<!-- Since the time intervals are considered open on the left and closed on the right, the value of the variable is observed at the right endpoint and stays constant ??? -->

### Right Censored Format

<!-- Since this study was solely concerned with survival time, the rows of follow up visits does not offer any additional insight to survival. -->
With the absence of time-dependent variables, the multiple rows of Table 1 do not provide additional information toward the time to event. A simplified form of the counting process data is often used instead. This form is called right censored data where each row corresponds to a single individual with their respective survival time. Censoring refers to an individual that does not experience the event during the period of study. In Table 1 and Table 2, individual 2 is considered censored, specifically right censored since they have not yet experienced the event by the end of their study time but will still experience the event after their observation times. The topic of censoring is outside the scope of this vignette but see (Cite) for more information. Table 3 shows an example of our survival study in right censored format. 

```{r, echo=FALSE, results = "asis"}
table4 <- data.frame(sid = c(1,2,3),
                     time1 = c(0,0,0),
                     time2 = c(96,33,28),
                     status = c(1,0,1))
pander::pandoc.table(data3, style = "rmarkdown", caption = "Table 4: Right Censored Data")
```

This form conveys the similar information as the previous in regard to survival time. Within the time interval $(0, 96]$, individual 1 experiences the event. With the absence of time-dependent variables, we can consolidate all follow-up intervals into one larger interval to more consicesly convey the time to event.


Additional simplifications are also possible. Since all individuals start at the same time point the start variable can be ommitted. That is, in this example, since each individual enrolls in the study at time 0, we do not need the start variable column. It can then be clearly stated all individuals start at time 0  and we need only include the possible event time.


## Application

The data formats described thus far are used for different statistical models. The counting process format is widely used in the `survival` package for implementing different proportional hazards models such as the Cox-proportional hazards model. The `flexsurv` package also uses this format and extends the `survival` package to add more flexible parametric proportional hazards models. The `msm` package uses the logitudinal data format to fit multi-state models. 

# Implementation



The development version of the package currently resides on GitHub at the following link: <https://github.com/ci2131a/wlsd>. It can be installed by running the code below. This installation requires the `devtools` package. If you have not already installed `devtools`, it can be installed by the traditional means from the comprehensive R archive network (CRAN) using `install.packages("devtools")`. 


```{r install}
devtools::install_github("ci2131a/wlsd")
```








# References

<!-- 
Therune survival vignette
Ther book
Collett
jackson paper
jackson vignette
-->



